#include <stdio.h>
#include <stdlib.h>
#include <locale.h>
#include <string.h>
#include <assert.h>
//.....................//
#define NOT_A_LETTER -10
#define CLEAN_ARRAY -1
#define ERROR_ARRAY -230
#define CANNOT_OPEN_FILE -231
#define GOOD_FUNCTION 0
//.....................//
typedef struct
{
    char * text_ptr ;
    int string_length;
} text_struct;
//.....................//
int              r_file_w_array (char * data_file ,char ** text , int * chr); // read file and writes to an array of structures || возвращает количество элементов
int              create_array_data(int * chr , int * nstr ,char ** text ); // функця создаёт массив и записывает туда данные из файла
int              compare_top (const void* ptr1, const void* ptr2);
int              cod (char * letter_ptr , int * c_letter_ptr);
int              cmt (const void* string1,const void* string2);
int              compare_botton (const void* ptr1, const void* ptr2);
int              cod (char * letter_ptr , int * c_letter_ptr);
int              create_array_struct (int * nstr ,int * chr , char ** text , text_struct ** array_struct );// функция создаёт масисив структур
//.....................//
int main ()
{
    setlocale(LC_ALL,"Russian");
    int i = 0;
    char * text = NULL ;
    int chr = 0;
    int nstr = 0;
    text_struct * array_struct = NULL;
    r_file_w_array("Test_Onegin.txt", &text , &chr);
    create_array_data (&chr , &nstr , &text);
    create_array_struct (&nstr , &chr ,&text,&array_struct);
    for ( int i = 0 ; i < nstr ; i++)
    {
        printf("%s \n", ((array_struct+i)->text_ptr ) );
    }
    //qsort (array_struct,nstr,sizeof(text_struct), compare_top);
    qsort (array_struct,nstr,sizeof(text_struct), cmt);
    for ( int i = 0 ; i < nstr ; i++)
    {
        printf("%s \n", ((array_struct+i)->text_ptr ) );
    }
    free(text);
    return GOOD_FUNCTION;
}

int r_file_w_array (char * data_file , char ** text , int * chr )
{
    FILE* file=fopen(data_file, "r");
    if (!file)
    {
        printf("Cannot open %s\n" , data_file);
        return CANNOT_OPEN_FILE;
    }
    fseek(file,0,SEEK_END);
    *chr = ftell(file);
    fseek( file , 0 , SEEK_SET );
    *text = (char *) calloc(*chr +1,sizeof(char));
    fread (*text , sizeof(char*) , *chr , file);
    printf("\n");
    fclose(file);
    return GOOD_FUNCTION ;

}
int create_array_data(int * chr , int * nstr ,char ** text )
{
    for(int i = 0 ; i < *chr ; i++)
    {
        if (*(*text + i)=='\n')
        {
            *nstr = *nstr + 1;
            *(*text + i)='\0';
            if (i+1 >= *chr)
            {
                break;
            }
            while ( *(*text + i+1) == '\n' || *(*text + i+1) == ' ' || *(*text + i+1) == '\t' )
            {
                i++;
            }
        }
    }
    printf("\n/количество символов %d\n/количество строк %d \n",*chr, *nstr);
    return GOOD_FUNCTION;
}
int  create_array_struct (int * nstr ,int * chr , char ** text , text_struct ** array_struct)
{
    *array_struct = (text_struct *) calloc (*nstr+1,sizeof(text_struct));
    (*array_struct)->text_ptr = *text;
    (*array_struct)->string_length = strlen(*text);
    int k = 1;
    for (int i = 0 ; i < *chr ; i ++ )
    {
        if ( *(*text + i) == '\0')
        {
            while ( *(*text + i+1) == '\n' || *(*text + i+1) == ' ' || *(*text + i+1) == '\t' || *(*text + i+1) == '\0')
            {
                i++;
                if (i+1 >= *chr)
                {
                    break;
                }
            }
            if (i+1 >= *chr)
            {
                break;
            }
            (*array_struct+k)->text_ptr = (*text+i+1);
            (*array_struct+k)->string_length = strlen(*text+i+1);
            k++;
        }
    }
    return GOOD_FUNCTION;
}
//....................................................//
int compare_top (const void* ptr1, const void* ptr2)
{
    int i = 0; // курсор первой строчки
    int k = 0; // курсор второй строчки
    int len = 0; // счетчик проверки равенства строк
    int c_string1 = 0;
    int c_string2 = 0;
    char * string1 = (*((const text_struct*) ptr1)).text_ptr;// адрес первой строчки
    char * string2 = ((const text_struct*) ptr2)->text_ptr;// адрес второй строчки
    int length1 = ((const text_struct*) ptr1)->string_length; // длина первой строчки
    int length2 = ((const text_struct*) ptr2)->string_length; // длина второй строчки
    while ( *(string1+i ) != '\0' || *(string2+k ) != '\0' )
    {
        cod ( string1+i , &c_string1 );
        cod ( string2+k , &c_string2 );
        if ( c_string1 != NOT_A_LETTER && c_string2 != NOT_A_LETTER )
        {
            if (c_string1>c_string2)
                return 1;
            if (c_string1<c_string2)
                return -1;
        }
        if (c_string1 == c_string2)
        {
            len++;
            i++;
            k++;
        }
        if ( c_string1 != NOT_A_LETTER && c_string2 == NOT_A_LETTER )
            k++;
        if ( c_string1 == NOT_A_LETTER && c_string2 != NOT_A_LETTER )
            i++;
    }
    if (len == length1)
        return 0 ;

}
//..............................................//
int cmt (const void* string1, const void* string2)
{
    return strcmp(*((char**) string1), *((char**) string2));
}
int compare_botton (const void* ptr1, const void* ptr2)
{
    int i = 0; // курсор первой строчки
    int k = 0; // курсор второй строчки
    int len = 0; // счетчик проверки равенства строк
    int c_string1 = 0;
    int c_string2 = 0;
    char * string1 = (*((const text_struct*) ptr1)).text_ptr;// адрес первой строчки
    char * string2 = ((const text_struct*) ptr2)->text_ptr;// адрес второй строчки
    int length1 = ((const text_struct*) ptr1)->string_length; // длина первой строчки
    int length2 = ((const text_struct*) ptr2)->string_length; // длина второй строчки
    while ( i < length1 || k < length2 )
    {
        cod (string1+length1-i , &c_string1 );
        cod (string2+length2-k , &c_string2 );
        if ( c_string1 != NOT_A_LETTER && c_string2 != NOT_A_LETTER )
        {
            if (c_string1>c_string2)
                return 1;
            if (c_string1<c_string2)
                return -1;
        }
        if (c_string1 == c_string2)
        {
            len++;
            i++;
            k++;
        }
        if ( c_string1 != NOT_A_LETTER && c_string2 == NOT_A_LETTER )
            k++;
        if ( c_string1 == NOT_A_LETTER && c_string2 != NOT_A_LETTER )
            i++;
    }
    if (len = length1)
        return 0;
}
